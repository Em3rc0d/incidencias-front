CREATE TABLE "empresa" (
  "empresa_id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "aseguradora_id" int,
  "nombre" varchar(100) UNIQUE NOT NULL,
  "ruc" varchar(50)
);

CREATE TABLE "aseguradora" (
  "aseguradora_id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "nombre" varchar(100) NOT NULL,
  "correo_contacto" varchar(100),
  "telefono" varchar(20)
);

CREATE TABLE "vehiculo" (
  "vehiculo_id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "empresa_id" int,
  "placa" varchar(10) UNIQUE NOT NULL,
  "marca" varchar(50),
  "modelo" varchar(50),
  "anio" int,
  "tipo" varchar(20),
  "estado" varchar(20) DEFAULT 'activo'
);

CREATE TABLE "usuario" (
  "usuario_id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "nombre" varchar(100) NOT NULL,
  "correo" varchar(100) UNIQUE NOT NULL,
  "contrasena" text NOT NULL,
  "rol" varchar(20)
);

CREATE TABLE "tipo_incidencia" (
  "tipo_incidencia_id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "nombre" varchar(100) UNIQUE NOT NULL,
  "descripcion" text
);

CREATE TABLE "incidencia" (
  "incidencia_id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "vehiculo_id" int,
  "usuario_id" int,
  "tipo_incidencia_id" int,
  "descripcion" text NOT NULL,
  "prioridad" varchar(10),
  "estado" varchar(20) DEFAULT 'abierta',
  "fecha_reporte" timestamp DEFAULT (CURRENT_TIMESTAMP)
);

CREATE TABLE "historial_incidencia" (
  "historial_id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "incidencia_id" int,
  "usuario_id" int,
  "estado" varchar(30),
  "observacion" text,
  "fecha" timestamp DEFAULT (CURRENT_TIMESTAMP)
);

CREATE TABLE "afectado" (
  "afectado_id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "incidencia_id" int,
  "nombre" varchar(100),
  "documento_identidad" varchar(20),
  "tipo_tercero" varchar(30),
  "contacto" varchar(100),
  "descripcion_danio" text
);

CREATE TABLE "reporte_aseguradora" (
  "reporte_id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "incidencia_id" int,
  "aseguradora_id" int,
  "fecha_envio" timestamp DEFAULT (CURRENT_TIMESTAMP),
  "estado_envio" varchar(20) DEFAULT 'pendiente',
  "asunto" varchar(150),
  "cuerpo" text,
  "observaciones" text
);

CREATE TABLE "evidencia" (
  "evidencia_id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "incidencia_id" int,
  "url_archivo" text NOT NULL,
  "tipo_archivo" varchar(20),
  "fecha_subida" timestamp DEFAULT (CURRENT_TIMESTAMP)
);

CREATE TABLE "historial_uso_vehiculo" (
  "historial_uso_id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "vehiculo_id" int,
  "usuario_id" int,
  "numero_vueltas" int,
  "fecha_inicio" timestamp DEFAULT (CURRENT_TIMESTAMP),
  "fecha_fin" timestamp
);

ALTER TABLE "empresa" ADD FOREIGN KEY ("aseguradora_id") REFERENCES "aseguradora" ("aseguradora_id");

ALTER TABLE "vehiculo" ADD FOREIGN KEY ("empresa_id") REFERENCES "empresa" ("empresa_id");

ALTER TABLE "incidencia" ADD FOREIGN KEY ("vehiculo_id") REFERENCES "vehiculo" ("vehiculo_id");

ALTER TABLE "incidencia" ADD FOREIGN KEY ("usuario_id") REFERENCES "usuario" ("usuario_id");

ALTER TABLE "incidencia" ADD FOREIGN KEY ("tipo_incidencia_id") REFERENCES "tipo_incidencia" ("tipo_incidencia_id");

ALTER TABLE "historial_incidencia" ADD FOREIGN KEY ("incidencia_id") REFERENCES "incidencia" ("incidencia_id");

ALTER TABLE "historial_incidencia" ADD FOREIGN KEY ("usuario_id") REFERENCES "usuario" ("usuario_id");

ALTER TABLE "afectado" ADD FOREIGN KEY ("incidencia_id") REFERENCES "incidencia" ("incidencia_id");

ALTER TABLE "reporte_aseguradora" ADD FOREIGN KEY ("incidencia_id") REFERENCES "incidencia" ("incidencia_id");

ALTER TABLE "reporte_aseguradora" ADD FOREIGN KEY ("aseguradora_id") REFERENCES "aseguradora" ("aseguradora_id");

ALTER TABLE "evidencia" ADD FOREIGN KEY ("incidencia_id") REFERENCES "incidencia" ("incidencia_id");

ALTER TABLE "historial_uso_vehiculo" ADD FOREIGN KEY ("vehiculo_id") REFERENCES "vehiculo" ("vehiculo_id");

ALTER TABLE "historial_uso_vehiculo" ADD FOREIGN KEY ("usuario_id") REFERENCES "usuario" ("usuario_id");

-- Aseguradoras
INSERT INTO aseguradora (nombre, correo_contacto, telefono) VALUES
('Seguros Perú', 'contacto@segurosperu.com', '987654321'),
('Aseguradora Lima', 'info@aseguradoralima.com', '123456789');

-- Empresas
INSERT INTO empresa (aseguradora_id, nombre, ruc) VALUES
(1, 'Transportes XYZ S.A.', '20123456789'),
(2, 'Logística ABC S.R.L.', '20456789123');

-- Vehículos
INSERT INTO vehiculo (empresa_id, placa, marca, modelo, anio, tipo, estado) VALUES
(1, 'ABC-123', 'Toyota', 'Hilux', 2018, 'privado', 'activo'),
(1, 'DEF-456', 'Hyundai', 'Tucson', 2020, 'privado', 'activo'),
(2, 'GHI-789', 'Mercedes', 'Sprinter', 2019, 'publico', 'activo');

-- Usuarios
INSERT INTO usuario (nombre, correo, contrasena, rol) VALUES
('Juan Perez', 'juan.perez@mail.com', 'hashedpass1', 'conductor'),
('Maria Lopez', 'maria.lopez@mail.com', 'hashedpass2', 'tecnico'),
('Carlos Gomez', 'carlos.gomez@mail.com', 'hashedpass3', 'admin');

-- Tipos de incidencia
INSERT INTO tipo_incidencia (nombre, descripcion) VALUES
('Accidente', 'Incidente que involucra daño físico o material'),
('Mantenimiento', 'Revisión o reparación programada'),
('Avería mecánica', 'Falla técnica del vehículo');

-- Incidencias
INSERT INTO incidencia (vehiculo_id, usuario_id, tipo_incidencia_id, descripcion, prioridad, estado) VALUES
(1, 1, 1, 'Choque leve en la parte trasera', 'media', 'abierta'),
(2, 2, 2, 'Cambio de aceite programado', 'baja', 'cerrada'),
(3, 1, 3, 'Falla en sistema de frenos', 'alta', 'abierta');

-- Historial de incidencias
INSERT INTO historial_incidencia (incidencia_id, usuario_id, estado, observacion) VALUES
(1, 3, 'en proceso', 'Se asignó técnico para evaluación'),
(1, 2, 'cerrada', 'Reparación completada y verificada'),
(3, 3, 'abierta', 'Pendiente diagnóstico');

-- Afectados
INSERT INTO afectado (incidencia_id, nombre, documento_identidad, tipo_tercero, contacto, descripcion_danio) VALUES
(1, 'Luis Fernandez', '12345678', 'persona', '999888777', 'Lesiones leves'),
(1, 'Vehículo ABC-123', NULL, 'vehiculo', NULL, 'Daño en parachoques trasero'),
(3, 'Infraestructura puente XYZ', NULL, 'infraestructura', NULL, 'Daño parcial en barandas');

-- Reportes aseguradora
INSERT INTO reporte_aseguradora (incidencia_id, aseguradora_id, estado_envio, asunto, cuerpo, observaciones) VALUES
(1, 1, 'enviado', 'Reporte accidente vehicular', 'Detalle del choque leve en la parte trasera del vehículo', 'Se adjuntaron evidencias'),
(3, 2, 'pendiente', 'Reporte falla mecánica', 'Se reporta falla crítica en sistema de frenos', NULL);

-- Evidencias
INSERT INTO evidencia (incidencia_id, url_archivo, tipo_archivo) VALUES
(1, 'http://imagenes.com/choque1.jpg', 'imagen'),
(1, 'http://videos.com/choque1.mp4', 'video'),
(3, 'http://documentos.com/reporte_frenos.pdf', 'documento');

-- Historial de uso de vehículos
INSERT INTO historial_uso_vehiculo (vehiculo_id, usuario_id, numero_vueltas, fecha_inicio, fecha_fin) VALUES
(1, 1, 5, '2025-05-01 08:00:00', '2025-05-01 17:00:00'),
(1, 2, 3, '2025-05-02 09:00:00', NULL),
(3, 1, 10, '2025-04-25 07:30:00', '2025-04-25 19:00:00');
